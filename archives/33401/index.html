<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    <meta charset="utf8"/>
    <meta name="viewport" content="initial-scale=1.0, width=device-width"/>
    <title>
      
      
        MQTT | C'est la vie
      
    </title>
    <meta name="description" content=""/>
    <meta name="keywords" content=""/>
    
      <link rel="apple-touch-icon"
            sizes="180x180"
            href="/assets/favicon/favicon-apple-touch.png"/>
    
    
      <link rel="icon"
            type="image/png"
            sizes="32x32"
            href="/assets/favicon/favicon-32x32.png"/>
    
    
      <link rel="icon"
            type="image/png"
            sizes="16x16"
            href="/assets/favicon/favicon-16x16.png"/>
    
    
      <link rel="mask-icon"
            href="/assets/favicon/favicon-logo.svg"
            color=""/>
    
    
    
      
  <style>
    @font-face {
        font-family:sourceHanSerif;
        src: url(/font/normal.ttf);
        font-weight: normal;
    }
  </style>

  <style>
    @font-face {
        font-family:sourceHanSerif;
        src: url(/font/bold.ttf);
        font-weight: bold;
    }
  </style>


    
    <link rel="stylesheet"
          type="text/css"
          href='/css/layout.css'/>
    
    
  <link rel="stylesheet" type="text/css" href="/css/post.css"/>
  
    <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css"/>
  

  <meta name="generator" content="Hexo 7.0.0"></head>
  <body>
    
      <div id="search-mask" style="display:none">
  <div class="search-main" id="search-main">
    <div class="search__head">
      <div class="search-form">
        <svg t="1706347533072"
             class="icon"
             viewBox="0 0 1024 1024"
             version="1.1"
             xmlns="http://www.w3.org/2000/svg"
             p-id="7828"
             width="20"
             height="20">
          <path d="M685.6 660.336l155.152 155.168a16 16 0 0 1 0 22.624l-11.312 11.328a16 16 0 0 1-22.624 0l-158.528-158.544a289.792 289.792 0 0 1-165.152 51.36C322.336 742.256 192 611.904 192 451.12 192 290.336 322.336 160 483.136 160c160.784 0 291.12 130.336 291.12 291.136 0 82.112-33.984 156.272-88.672 209.2z m-202.464 33.92c134.272 0 243.12-108.848 243.12-243.12C726.256 316.848 617.408 208 483.136 208 348.848 208 240 316.848 240 451.136c0 134.272 108.848 243.12 243.136 243.12z" fill="#000000" p-id="7829">
          </path>
        </svg>
        <input id="search-input" placeholder="搜索文章">
        <svg t="1706361500528"
             id="search-clear"
             class="icon"
             viewBox="0 0 1024 1024"
             version="1.1"
             xmlns="http://www.w3.org/2000/svg"
             p-id="4351"
             width="20"
             height="20">
          <path d="M512 562.688l-264.2944 264.2944-50.688-50.688L461.312 512 197.0176 247.7056l50.688-50.688L512 461.312l264.2944-264.2944 50.688 50.688L562.688 512l264.2944 264.2944-50.688 50.688L512 562.688z" fill="#00" p-id="4352">
          </path>
        </svg>
      </div>
    </div>
    <div class="search__body" id="search-result"></div>
    <div class="search__foot"></div>
  </div>
</div>

    
    <div class="head">
      <div class="nav">
        <a href='/' class="nav-logo">
          <img alt="logo" height="60px" width="60px" src="/assets/favicon/favicon-logo.svg"/>
        </a>
        <input id="navBtn" type="checkbox"/>
        <div class="nav-right">
          
            <div class="search-outer">
  <div class="search" id="search-btn">
    <svg t="1706347533072"
         class="icon"
         viewBox="0 0 1024 1024"
         version="1.1"
         xmlns="http://www.w3.org/2000/svg"
         p-id="7828"
         width="20"
         height="20">
      <path d="M685.6 660.336l155.152 155.168a16 16 0 0 1 0 22.624l-11.312 11.328a16 16 0 0 1-22.624 0l-158.528-158.544a289.792 289.792 0 0 1-165.152 51.36C322.336 742.256 192 611.904 192 451.12 192 290.336 322.336 160 483.136 160c160.784 0 291.12 130.336 291.12 291.136 0 82.112-33.984 156.272-88.672 209.2z m-202.464 33.92c134.272 0 243.12-108.848 243.12-243.12C726.256 316.848 617.408 208 483.136 208 348.848 208 240 316.848 240 451.136c0 134.272 108.848 243.12 243.136 243.12z" fill="#000000" p-id="7829">
      </path>
    </svg>
    <span>搜索</span>
    <span class="search-shortcut-key">Ctrl K</span>
  </div>
</div>

          
          <div class="nav-menu">
            
              
                <a class="nav-menu-item" href="/computer">计算机</a>
              
                <a class="nav-menu-item" href="/math">数学</a>
              
                <a class="nav-menu-item" href="/physic">物理</a>
              
                <a class="nav-menu-item" href="/life">生活随笔</a>
              
            
          </div>
        </div>
        <label class="nav-btn" for="navBtn"></label>
      </div>
    </div>
    <div class="body">
      
  <article class="post-content">
    <div class="post-inner--toc">
      <div class="post-content__head">
        <div class="post-title">MQTT</div>
        <div class="post-info">
          
  
    <a href="/tags/%E8%BD%AF%E4%BB%B6%E5%BC%80%E5%8F%91/" class="post-tag">#软件开发</a>
  


          <span class="post-date">2023-08-30</span>
        </div>
      </div>
      
        <aside class="toc-outer">
          <div class="toc-title">目录</div>
          <ol class="post-toc"><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#mqtt-%E5%8D%8F%E8%AE%AE%E6%A6%82%E8%A6%81"><span class="post-toc-number">1.</span> <span class="post-toc-text">MQTT 协议概要</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E5%8F%91%E5%B8%83-%E8%AE%A2%E9%98%85%E6%A8%A1%E5%BC%8F"><span class="post-toc-number">1.1.</span> <span class="post-toc-text">发布-订阅模式</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E6%B6%88%E6%81%AF%E8%BF%87%E6%BB%A4"><span class="post-toc-number">1.2.</span> <span class="post-toc-text">消息过滤</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#mqtt-%E4%B8%8E%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="post-toc-number">1.3.</span> <span class="post-toc-text">MQTT 与消息队列的区别</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#mqtt-%E9%87%8D%E8%A6%81%E6%A6%82%E5%BF%B5"><span class="post-toc-number">2.</span> <span class="post-toc-text">MQTT 重要概念</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#mqtt-client"><span class="post-toc-number">2.1.</span> <span class="post-toc-text">MQTT Client</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#mqtt-broker"><span class="post-toc-number">2.2.</span> <span class="post-toc-text">MQTT Broker</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#mqtt-connection"><span class="post-toc-number">2.3.</span> <span class="post-toc-text">MQTT Connection</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#%E6%B6%88%E6%81%AF%E5%88%97%E8%A1%A8"><span class="post-toc-number">3.</span> <span class="post-toc-text">消息列表</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#connect"><span class="post-toc-number">3.1.</span> <span class="post-toc-text">CONNECT</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#connack"><span class="post-toc-number">3.2.</span> <span class="post-toc-text">CONNACK</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#publish"><span class="post-toc-number">3.3.</span> <span class="post-toc-text">PUBLISH</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#subscribe"><span class="post-toc-number">3.4.</span> <span class="post-toc-text">SUBSCRIBE</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#suback"><span class="post-toc-number">3.5.</span> <span class="post-toc-text">SUBACK</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#unsubscribe"><span class="post-toc-number">3.6.</span> <span class="post-toc-text">UNSUBSCRIBE</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#unsuback"><span class="post-toc-number">3.7.</span> <span class="post-toc-text">UNSUBACK</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#%E4%B8%BB%E9%A2%98topic"><span class="post-toc-number">4.</span> <span class="post-toc-text">主题（Topic）</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E9%80%9A%E9%85%8D%E7%AC%A6"><span class="post-toc-number">4.1.</span> <span class="post-toc-text">通配符</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E4%BB%A5-%E5%BC%80%E5%A4%B4%E7%9A%84%E4%B8%BB%E9%A2%98"><span class="post-toc-number">4.2.</span> <span class="post-toc-text">以 $ 开头的主题</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="post-toc-number">5.</span> <span class="post-toc-text">参考资料</span></a></li></ol>
          <a href="#" class="toc-top">回到顶部</a>
        </aside>
      
      <div class="post-content__body">
        
          <div class="post-gallery">
            
          </div>
        
        <p><code>MQTT</code> （Message Queue Telemetry
Transport，消息队列遥测传输协议），是一种基于发布-订阅（<code>publish-subscribe</code>）模式的<code>轻量级</code>通讯协议，该协议构建于
<code>TCP/IP</code> 协议上。</p>
<span id="more"></span>
<p>MQTT
协议的主要特征是开放、简单、轻量级和易于实现，这些特征使得它适用于受约束的应用环境，如：</p>
<blockquote>
<p><code>网络受限</code>：网络带宽较低且传输不可靠</p>
<p><code>终端受限</code>：协议运行在嵌入式设备上，嵌入式终端的处理器、内存等是受限的</p>
</blockquote>
<h1 id="mqtt-协议概要">MQTT 协议概要</h1>
<h2 id="发布-订阅模式">发布-订阅模式</h2>
<p>发布-订阅模式定义了一种一对多的依赖关系，让多个订阅者对象同时监听某一个主题对象。这个主题对象在自身状态变化时，会通知所有订阅者对象，使它们能够自动更新自己的状态。</p>
<p>该协议将消息的发布者（<code>publisher</code>）与订阅者（<code>subscriber</code>）进行分离，因此可以在不可靠的网络环境中，为远程连接的设备提供可靠的消息服务，使用方式与传统的
MQ 有点类似。</p>
<figure>
<img src="/archives/33401/publish_subscribe.png" alt="publish-subscribe">
<figcaption aria-hidden="true">publish-subscribe</figcaption>
</figure>
<p>发布-订阅模式最重要的方面是消息的发布者与订阅者的解耦。这种解耦有几个维度：</p>
<ul>
<li>空间解耦：发布者和订阅者不需要相互了解（例如，不交换 IP
地址和端口）。</li>
<li>时间解耦：发布者和订阅者不需要同时运行。</li>
<li>同步解耦：两个组件的操作在发布或接收时不需要中断。</li>
</ul>
<p>总之，发布-订阅模式消除了传统客户端-服务器之间的直接通信，把通信这个操作交给了
broker 进行代理，并在空间、时间、同步三个维度上进行了解藕。</p>
<p>发布-订阅模式比传统的客户端-服务器模式有了更好的扩展性：</p>
<ul>
<li>broker 高度并行化，基于事件驱动；</li>
<li>消息的缓存和消息的智能路由；</li>
<li>可以通过集群代理来实现数百万的连接，使用负载均衡器将负载分配到更多的单个服务器上。</li>
</ul>
<h2 id="消息过滤">消息过滤</h2>
<p>很明显，broker
在发布-订阅过程中起着举足轻重的作用。但是代理如何过滤所有消息，以便每个订阅者只接收感兴趣的消息？broker
有几个可以过滤的选项：</p>
<ul>
<li><p>基于主题的过滤：</p>
<p>此过滤基于属于每条消息的主题。接收客户端向代理订阅感兴趣的主题，订阅后，broker
就会确保客户端收到发布到 topic 中的消息。</p></li>
<li><p>基于内容的过滤：</p>
<p>在基于内容的过滤中，broker
会根据特定的内容过滤消息，接受客户端会经过过滤他们感兴趣的内容。这种方法的一个显著的缺点就是必须事先知道消息的内容，不能加密或者轻易修改。</p></li>
<li><p>基于类型的过滤：</p>
<p>当使用面向对象的语言时，基于消息（事件）的类型/类进行过滤是一种常见做法。例如，订阅者可以收听所有类型为
Exception 或任何子类型的消息。</p></li>
</ul>
<h2 id="mqtt-与消息队列的区别">MQTT 与消息队列的区别</h2>
<ul>
<li><p>消息队列存储消息直到消息被消费：</p>
<p>使用消息队列时，每条传入消息都存储在队列中，直到被客户端（通常称为消费者）接收。如果没有客户端接收到消息，消息将保持在队列中并等待被消费。在消息队列中，不会存在消息没有客户端消费的情况，但是在
MQTT 中，却存在 topic 无 subscriber 订阅的情况。</p></li>
<li><p>一条消息只被一个客户端消费：</p>
<p>在传统的消息队列中，一条消息只能被一个消费者处理。负载分布在队列的所有消费者之间。在
MQTT
中，行为完全相反：订阅主题的每个订阅者都会收到消息，每个订阅者有相同的负载。</p></li>
<li><p>队列是命名的，必须显式创建：</p>
<p>队列比主题严格得多。在使用队列之前，必须使用单独的命令显式创建队列。只有在队列命名和创建之后，才可以发布或消费消息。相比之下，MQTT
主题非常灵活，可以即时创建。</p></li>
</ul>
<h1 id="mqtt-重要概念">MQTT 重要概念</h1>
<h2 id="mqtt-client">MQTT Client</h2>
<p><code>publisher</code> 和 <code>subscriber</code> 都属于 MQTT
Client。发布者和订阅者是一种相对的概念，指的是当前客户端是在发布消息还是在接收消息。发布和订阅的功能也可以由同一个
MQTT Client 实现。</p>
<h2 id="mqtt-broker">MQTT Broker</h2>
<p>与 MQTT Client 对应的就是 MQTT Broker。 <code>Broker</code>
是任何发布-订阅协议的核心，根据实现的不同，代理可以处理多达数百万连接的
MQTT Client。</p>
<p>Broker 的责任：</p>
<ul>
<li>接收所有消息，过滤消息，确定是哪个 Client
订阅了消息，并将消息发送给对应的 Client；</li>
<li>保存会话数据，这些数据包括订阅的和错过的消息；</li>
<li>客户端的身份验证和授权。</li>
</ul>
<h2 id="mqtt-connection">MQTT Connection</h2>
<p><code>TCP</code>
协议位于传输层，<code>MQTT</code> 协议位于应用层，<code>MQTT</code> 协议构建于
<code>TCP/IP</code> 协议上。客户端和代理都需要有一个 TCP/IP
协议支持。</p>
<figure>
<img src="/archives/33401/MQTT_layer.png" alt="MQTT layer">
<figcaption aria-hidden="true">MQTT layer</figcaption>
</figure>
<p>MQTT
连接始终位于一个客户端和代理之间。客户端从不直接相互连接。要发起连接，客户端向代理发送
<code>CONNECT</code> 消息。代理使用 <code>CONNACK</code>
消息和状态代码进行响应。建立连接后，代理将保持打开状态，直到客户端发送断开连接命令或连接中断。</p>
<figure>
<img src="/archives/33401/connection.png" alt="MQTT Connection">
<figcaption aria-hidden="true">MQTT Connection</figcaption>
</figure>
<h1 id="消息列表">消息列表</h1>
<h2 id="connect">CONNECT</h2>
<p>为了创建连接，客户端向代理发送此命令消息。如果此 CONNECT
消息格式错误或打开网络套接字和发送连接消息之间的时间过长，代理将关闭连接。</p>
<p>一个 MQTT 客户端发送一条 CONNECT 连接，这条 CONNECT
连接可能会包含下面这些信息：</p>
<figure>
<img src="/archives/33401/CONNECT.png" alt="CONNECT">
<figcaption aria-hidden="true">CONNECT</figcaption>
</figure>
<ul>
<li><p><code>clientId</code>：</p>
<p>ClientId 的长度可以是 1-23 个字符，在一个服务器上 ClientId
不能重复。如果超过 23 个字符，则服务器返回 CONNACK 消息中的返回码为
Identifier Rejected。在 MQTT 3.1.1
中，如果不需要代理持有状态，可以发送一个空的 ClientId。空的 ClientId
导致连接没有任何状态。在这种情况下，clean session 标志必须设置为
true，否则代理将拒绝连接。</p></li>
<li><p><code>cleanSession</code>：</p>
<p>Clean Session 标志告诉代理客户端是否要建立持久会话。在持久会话
(CleanSession = false)
中，代理存储客户端的所有订阅以及以服务质量（QoS）级别 1 或 2
订阅的客户端的所有丢失消息。 如果会话不是持久的 (CleanSession = true
)，代理不为客户端存储任何内容，并清除任何先前持久会话中的所有信息。</p></li>
<li><p><code>username/password</code>：</p>
<p>MQTT
可以发送用户名和密码进行客户端认证和授权。但是，如果此信息未加密或散列，则密码将以纯文本形式发送。我们强烈建议将用户名和密码与安全传输一起使用。像
HiveMQ 这样的代理可以使用 SSL
证书对客户端进行身份验证，因此不需要用户名和密码。</p></li>
<li><p><code>willMessage</code>：</p>
<p>LastWillxxx 表示的是遗愿，client 在连接 broker
的时候将会设立一个遗愿，这个遗愿会保存在 broker 中，当 client
因为非正常原因断开与 broker 的连接时，broker 会将遗愿发送给订阅了这个
topic（订阅遗愿的 topic）的 client。</p></li>
<li><p><code>keepAlive</code>：</p>
<p>keepAlive 是 client 在连接建立时与 broker
通信的时间间隔，通常以秒为单位。这个时间指的是 client 与 broker
在不发送消息下所能承受的最大时长。</p></li>
</ul>
<h2 id="connack">CONNACK</h2>
<p>当 broker 收到 CONNECT 消息时，它有义务回复 CONNACK
消息进行响应。CONNACK 消息包括两部分内容：</p>
<figure>
<img src="/archives/33401/CONNACK.png" alt="CONNACK">
<figcaption aria-hidden="true">CONNACK</figcaption>
</figure>
<ul>
<li><p><code>sessionPresent</code>：</p>
<p>会话当前标志，这个标志会告诉 client 当前 broker
是否有一个持久性会话与 client 进行交互。SessionPresent 标志和
CleanSession 标志有关，当 client 在 CleanSession 设置为 true
的情况下连接时，SessionPresent 始终为
false，因为没有持久性会话可以使用。如果 CleanSession 设置为
false，则有两种可能性：</p>
<ul>
<li>如果 ClientId 的会话信息可用，并且 broker 已经存储了会话信息，那么
SessionPresent 为 true；</li>
<li>否则如果没有 ClientId 的任何会话信息，那么 SessionPresent 为
false。</li>
</ul>
<figure>
<img src="/archives/33401/sessionPresent.png" alt="sessionPresent">
<figcaption aria-hidden="true">sessionPresent</figcaption>
</figure></li>
<li><p><code>returnCode</code>：</p>
<p>连接返回码，告诉客户端连接尝试是否成功。连接确认标志有下面这些选项：</p>
<figure>
<img src="/archives/33401/CONNACK_returnCode.png" alt="returnCode">
<figcaption aria-hidden="true">returnCode</figcaption>
</figure></li>
</ul>
<h2 id="publish">PUBLISH</h2>
<p>MQTT 客户端可以在连接到 broker 后立即发布消息。MQTT 使用的是基于
topic 主题的过滤。每条消息都必须包含一个主题，broker
可以使用该主题将消息转发给感兴趣的客户端。通常，每条消息都有一个负载（Payload），其中包含要以字节格式传输的数据。MQTT
是数据无关性的，也就是说数据是由发布者决定要发送的是 XML 、JSON
还是二进制数据、文本数据。</p>
<figure>
<img src="/archives/33401/PUBLISH.png" alt="PUBLISH">
<figcaption aria-hidden="true">PUBLISH</figcaption>
</figure>
<ul>
<li><p><code>packetId</code>：</p>
<p>这个 packetId 标识在 client 和 broker 之间唯一的消息标识。packetId
仅与大于零的 QoS 级别相关。</p></li>
<li><p><code>topicName</code>：</p>
<p>主题名称是一个简单的字符串，它以正斜杠作为分隔符进行分层结构。例如，“我的家/客厅/温度”或“德国/慕尼黑/十月节/人”。</p></li>
<li><p><code>qos</code>：</p>
<p>此数字表示消息的服务质量 (QoS)。有三个级别：0、1 和
2。服务级别决定了消息到达预期接收者（客户端或代理）的保证类型。</p></li>
<li><p><code>retainFlag</code>：</p>
<p>此标志表示 broker 将最近收到的一条 RETAIN 标志位为 true
的消息保存在服务器端（内存或者文件）。</p></li>
<li><p><code>payload</code>：</p>
<p>这个是每条消息的实际内容。MQTT
是数据无关性的。可以发送任何文本、图像、加密数据以及二进制数据。</p></li>
<li><p><code>dupFlag</code>：</p>
<p>该标志表明该消息是重复的并且由于预期的接收者（客户端或代理）没有确认原始消息而被重新发送。仅与
QoS 大于 0 的级别相关。</p></li>
</ul>
<p>当客户端向 MQTT broker 发送消息进行发布时，broker
读取消息、确认消息（根据 QoS 级别）并处理消息。broker
的处理包括确定哪些客户端订阅了主题并将消息发送给他们。</p>
<figure>
<img src="/archives/33401/PUBLISH_broker.png" alt="PUBLISH broker">
<figcaption aria-hidden="true">PUBLISH broker</figcaption>
</figure>
<p>最初发布消息的客户端只关心将 PUBLISH 消息传递给 broker。一旦 broker
收到 PUBLISH 消息，broker
就有责任将消息传递给所有订阅者。发布客户端不会得到关于是否有人对发布的消息感兴趣或有多少客户端从
broker 收到消息的任何反馈。</p>
<h2 id="subscribe">SUBSCRIBE</h2>
<p>client 会向 broker 发送 SUBSCRIBE 消息来接收有关感兴趣的 topic。</p>
<figure>
<img src="/archives/33401/SUBSCRIBE.png" alt="SUBSCRIBE">
<figcaption aria-hidden="true">SUBSCRIBE</figcaption>
</figure>
<ul>
<li><p><code>packetId</code>：</p>
<p>消息的唯一标识符。与 PUBLISH 消息的 packetId 一样。</p></li>
<li><p><code>List of Subscriptions</code>：</p>
<p>订阅列表。一个 SUBSCRIBE
消息可以包含一个客户端的多个订阅。每个订阅由一个主题和一个 QoS
级别组成。订阅消息中的主题可以包含通配符，使订阅主题模式而不是特定主题成为可能。如果一个客户端存在重叠订阅，则代理会传送该主题具有最高
QoS 级别的消息。</p></li>
</ul>
<h2 id="suback">SUBACK</h2>
<p>为了确认每个订阅，broker 向客户端发送一个 SUBACK 确认消息。</p>
<figure>
<img src="/archives/33401/SUBACK.png" alt="SUBACK">
<figcaption aria-hidden="true">SUBACK</figcaption>
</figure>
<ul>
<li><p><code>packetId</code>：</p>
<p>消息的唯一标识符。与 SUBSCRIBE 消息的一样。</p></li>
<li><p><code>returnCode</code>：</p>
<p>broker 为它在 SUBSCRIBE 消息中收到的每个主题/QoS
对发送一个返回代码。例如，如果 SUBSCRIBE 消息有五个订阅，则 SUBACK
消息包含五个返回码。返回码确认每个主题并显示 broker 授予的 QoS
级别。如果 broker 拒绝订阅，则 SUBACK
消息包含该特定主题的失败返回代码。例如，如果客户端没有足够的权限订阅主题或主题格式错误。</p>
<figure>
<img src="/archives/33401/SUBACK_returnCode.png" alt="SUBACK returnCode">
<figcaption aria-hidden="true">SUBACK returnCode</figcaption>
</figure></li>
</ul>
<p>客户端成功发送 SUBSCRIBE 消息并收到 SUBACK 消息后，它会获取与
SUBSCRIBE 消息包含的订阅中的主题匹配的每条已发布消息。</p>
<figure>
<img src="/archives/33401/SUBSCRIBE_SUBACK.png" alt="SUBSCRIBE SUBACK">
<figcaption aria-hidden="true">SUBSCRIBE SUBACK</figcaption>
</figure>
<h2 id="unsubscribe">UNSUBSCRIBE</h2>
<p>SUBSCRIBE 消息的对应是 UNSUBSCRIBE 消息。此消息删除 broker
上客户端的现有订阅。</p>
<figure>
<img src="/archives/33401/UNSUBSCRIBE.png" alt="UNSUBSCRIBE">
<figcaption aria-hidden="true">UNSUBSCRIBE</figcaption>
</figure>
<ul>
<li><p><code>packetId</code>：</p>
<p>消息的唯一标识符。与 PUBLISH 消息的 packetId 一样。</p></li>
<li><p><code>List of Topics</code>：</p>
<p>主题列表。需要取消订阅的主题。</p></li>
</ul>
<h2 id="unsuback">UNSUBACK</h2>
<p>为了确认取消订阅，broker 向客户端发送一个 UNSUBACK 确认消息。</p>
<figure>
<img src="/archives/33401/UNSUBACK.png" alt="UNSUBACK">
<figcaption aria-hidden="true">UNSUBACK</figcaption>
</figure>
<ul>
<li><p><code>packetId</code>：</p>
<p>消息的唯一标识符。与 UNSUBSCRIBE 消息的 packetId 一样。</p></li>
</ul>
<p>客户端收到来自 broker 的 UNSUBACK 后，可以认为 UNSUBSCRIBE
消息中的订阅被删除了。</p>
<figure>
<img src="/archives/33401/UNSUBSCRIBE_UNSUBACK.png" alt="UNSUBSCRIBE UNSUBACK">
<figcaption aria-hidden="true">UNSUBSCRIBE UNSUBACK</figcaption>
</figure>
<h1 id="主题topic">主题（Topic）</h1>
<p>在 MQTT 中，主题指的是 broker 用于为每个连接的客户端过滤消息的 UTF-8
字符串。主题由一个或多个主题级别组成。每个主题级别由正斜杠（主题级别分隔符）分隔。</p>
<figure>
<img src="/archives/33401/topic.png" alt="topic">
<figcaption aria-hidden="true">topic</figcaption>
</figure>
<p>与消息队列相比，MQTT
主题非常轻量级。客户端在发布或订阅它之前不需要创建所需的主题。broker
接受每个有效主题而无需任何事先初始化。</p>
<h2 id="通配符">通配符</h2>
<p>当客户端订阅主题时，它可以订阅已发布消息的确切主题，也可以使用通配符同时订阅多个主题。通配符只能用于订阅主题，不能用于发布消息。有两种不同类型的通配符：单级和多级。</p>
<ul>
<li><p>单级：+</p>
<p>单级通配符只替换一个主题级别。</p>
<figure>
<img src="/archives/33401/single_wildcard.png" alt="single wildcard">
<figcaption aria-hidden="true">single wildcard</figcaption>
</figure>
<p>上述的主题匹配可以产生以下结果</p>
<figure>
<img src="/archives/33401/single_wildcard_result.png" alt="single wildcard result">
<figcaption aria-hidden="true">single wildcard result</figcaption>
</figure></li>
<li><p>多级：#</p>
<p>多级通配符涵盖多个主题级别。多级通配符必须作为主题中的最后一个字符放置，并以正斜杠开头。</p>
<figure>
<img src="/archives/33401/multi_wildcard_result.png" alt="multi wildcard">
<figcaption aria-hidden="true">multi wildcard</figcaption>
</figure>
<p>上述的主题匹配可以产生以下结果</p>
<figure>
<img src="/archives/33401/multi_wildcard_result.png" alt="multi wildcard result">
<figcaption aria-hidden="true">multi wildcard result</figcaption>
</figure></li>
</ul>
<h2 id="以-开头的主题">以 $ 开头的主题</h2>
<p>$ 主题保留用于 MQTT
代理的内部统计信息。客户端无法向这些主题发布消息。目前，此类主题尚无官方标准化，代理实现各不相同，但通常用
<code>$SYS/</code> 来表示这类信息。<a target="_blank" rel="noopener" href="https://github.com/mqtt/mqtt.org/wiki/SYS-Topics">MQTT GitHub
wiki</a> 中提供了对 <code>$SYS-topics</code> 的一项建议。</p>
<blockquote>
<p>$SYS/broker/clients/connected</p>
<p>$SYS/broker/clients/disconnected</p>
<p>$SYS/broker/clients/total</p>
<p>$SYS/broker/messages/sent</p>
<p>$SYS/broker/uptime</p>
</blockquote>
<h1 id="参考资料">参考资料</h1>
<ul>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/riemann_/article/details/118686072">一文读懂物联网
MQTT 协议之基础特性篇</a></li>
</ul>

      </div>
    </div>
    
      <script src='https://unpkg.com/mermaid@latest/dist/mermaid.min.js'></script>
      <script>
        if (window.mermaid) {
          mermaid.initialize([object Object]);
        }
      </script>
    
  </article>
  <div class="post__foot">
    
      <div class="like-author">
  <input type="checkbox" id="likeCode" />
  <div class="author-face">
    <img height="100px"
         width="100px"
         id="front-face"
         alt="author face"
         src="/assets/reward/avatar.png" />
    <img height="100px"
         width="100px"
         id="back-face"
         alt="like code"
         src="/assets/reward/sponsor.png" />
  </div>
  <div class="like-text">
    给作者倒杯卡布奇诺
  </div>
  <label for="likeCode" class="like-btn">
    <svg viewBox="0 0 1024 1024"
         width="20px"
         style="margin-right: 10px"
         height="20px">
      <path d="M466.88 908.96L113.824 563.296a270.08 270.08 0 0 1 0-387.392c108.8-106.56 284.896-106.56 393.696 0 1.504 1.472 2.976 2.944 4.448 4.48 1.472-1.536 2.944-3.008 4.448-4.48 108.8-106.56 284.896-106.56 393.696 0a269.952 269.952 0 0 1 34.016 347.072l-387.392 385.6a64 64 0 0 1-89.92 0.384z" p-id="13650" fill="#ee4242" />
    </svg>
    喜欢作者
  </label>
</div>

    
    <div class="post-nav">
  
    <a class="post-nav-item-left" href="/archives/36029/">
      <div class="text-align">
        <svg t="1670570876164"
             class="icon"
             viewBox="0 0 1024 1024"
             width="16"
             height="16">
          <path d="M384 512L731.733333 202.666667c17.066667-14.933333 19.2-42.666667 4.266667-59.733334-14.933333-17.066667-42.666667-19.2-59.733333-4.266666l-384 341.333333c-10.666667 8.533333-14.933333 19.2-14.933334 32s4.266667 23.466667 14.933334 32l384 341.333333c8.533333 6.4 19.2 10.666667 27.733333 10.666667 12.8 0 23.466667-4.266667 32-14.933333 14.933333-17.066667 14.933333-44.8-4.266667-59.733334L384 512z" p-id="14596"/>
        </svg>
        <span class="text-small">上一篇</span>
      </div>
      <div>URL去重策略（布隆过滤器）</div>
    </a>
  
  <div class="vhr"></div>
  
    <a class="post-nav-item-right" href="/archives/42877/">
      <div class="text-align">
        <span class="text-small">下一篇</span>
        <svg t="1670570876164"
             class="icon"
             viewBox="0 0 1024 1024"
             transform="scale(-1,-1)"
             width="16"
             height="16">
          <path d="M384 512L731.733333 202.666667c17.066667-14.933333 19.2-42.666667 4.266667-59.733334-14.933333-17.066667-42.666667-19.2-59.733333-4.266666l-384 341.333333c-10.666667 8.533333-14.933333 19.2-14.933334 32s4.266667 23.466667 14.933334 32l384 341.333333c8.533333 6.4 19.2 10.666667 27.733333 10.666667 12.8 0 23.466667-4.266667 32-14.933333 14.933333-17.066667 14.933333-44.8-4.266667-59.733334L384 512z" p-id="14596"/>
        </svg>
      </div>
      二分查找
    </a>
  
</div>

    
      <div class="related-post">
  <div class="related__head">
    
  
    <a href="/tags/%E8%BD%AF%E4%BB%B6%E5%BC%80%E5%8F%91/" class="post-tag">#软件开发</a>
  


  </div>
  <div class="realated__body">
    
      <div class="null"><div class="null-item"><div class="null-title"><a href="\archives\38008\" title="Maven" rel="bookmark">Maven</a></div></div><div class="null-item"><div class="null-title"><a href="\archives\27652\" title="RBAC权限管理" rel="bookmark">RBAC权限管理</a></div></div><div class="null-item"><div class="null-title"><a href="\archives\36029\" title="URL去重策略（布隆过滤器）" rel="bookmark">URL去重策略（布隆过滤器）</a></div></div><div class="null-item"><div class="null-title"><a href="\archives\24050\" title="Base64编码" rel="bookmark">Base64编码</a></div></div><div class="null-item"><div class="null-title"><a href="\archives\55509\" title="CAP & BASE" rel="bookmark">CAP & BASE</a></div></div></div>
    
  </div>
</div>

    
    
      <div id="gitalk-container"></div>
    
  </div>

    </div>
    <div class="foot">
      <div class="foot-inner">
        <div class="foot__head">
          
            <div class="foot-line">
              
                <div class="matts">海</div>
              
                <div class="matts">内</div>
              
                <div class="matts">存</div>
              
                <div class="matts">知</div>
              
                <div class="matts">己</div>
              
            </div>
          
            <div class="foot-line">
              
                <div class="matts">天</div>
              
                <div class="matts">涯</div>
              
                <div class="matts">若</div>
              
                <div class="matts">比</div>
              
                <div class="matts">邻</div>
              
            </div>
          
        </div>
        <div class="foot__body">
          
            <div class="foot-item">
              <div class="foot-item__head">友链</div>
              <div class="foot-item__body">
                
                  <div class="text">
                    <img alt="link" height="20px" width="20px" src="/assets/icon/icon-link.svg"/>
                    <a class="foot-link" target="_blank" rel="noopener" href="https://shennoter.top/">Shennoter</a>
                  </div>
                
                  <div class="text">
                    <img alt="link" height="20px" width="20px" src="/assets/icon/icon-link.svg"/>
                    <a class="foot-link" href="">Jobove</a>
                  </div>
                
              </div>
            </div>
          
          
            <div class="foot-item">
              <div class="foot-item__head">账号</div>
              <div class="foot-item__body">
                
                  <div class="text">
                    <img alt="link" height="20px" width="20px" src="/assets/logo/logo-github.svg"/>
                    <a class="foot-link" target="_blank" rel="noopener" href="https://github.com/Lynchrocket">Lynchrocket</a>
                  </div>
                
                  <div class="text">
                    <img alt="link" height="20px" width="20px" src="/assets/logo/logo-zh.svg"/>
                    <a class="foot-link" target="_blank" rel="noopener" href="https://www.zhihu.com/people/lynchrocket">Lynchrocket</a>
                  </div>
                
              </div>
            </div>
          
          <div class="foot-item">
            <div class="foot-item__head">联系</div>
            <div class="foot-item__body">
              <div class="text">
                <img alt="link" height="20px" width="20px" src="/assets/icon/icon-email.svg"/>
                <a class="foot-link" href="mailto:lynchrocket@gmail.com">lynchrocket@gmail.com</a>
              </div>
            </div>
          </div>
          
          <div class="foot-item">
            <div class="foot-item__head">访客</div>
            <div class="foot-item__body">
              <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
              <span id="busuanzi_container_site_uv">本站总访问量：<span id="busuanzi_value_site_uv"></span>次</span>
            </div>
          </div>
          
        </div>
        <div class="copyright">
          <a href="https://lynchrocket.github.io">C'est la vie</a> &nbsp;|&nbsp;
          由&nbsp;<a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>&nbsp;
          及&nbsp;<a target="_blank" rel="noopener" href="https://github.com/Lynchrocket/hexo-theme-senerity">Senerity</a>&nbsp;驱动
        </div>
      </div>
    </div>
    
      <script src="https://unpkg.com/js-polyfills@0.1.43/es6.js"></script>
      <script id="MathJax-script"
              async
              src="https://www.unpkg.com/mathjax@3.2.2/es5/tex-mml-chtml.js"></script>
    
    
      <script src="/js/search.js"></script>
      <script>searchInitialize("/search.json")</script>
    
    
  
    <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
<script type="text/javascript">
  const param = JSON.parse('{"enable":true,"owner":"Lynchrocket","admin":"Lynchrocket","repo":"Lynchrocket.github.io","clientID":"45d8817d291626df7894","clientSecret":"2761427f37f733d92cc64be2e2a3826cc8454cf3","distractionFreeMode":false,"proxy":"https://worker-lingering-hat-47a4.lynchrocket.workers.dev/?https://github.com/login/oauth/access_token","language":"zh-CN","per_page":20}')
  param.id = location.pathname
  const gitalk = new Gitalk(param)
  gitalk.render('gitalk-container')
</script>

  

  </body>
</html>